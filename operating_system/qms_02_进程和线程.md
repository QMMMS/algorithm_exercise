# 进程和线程

## 进程

程序是储存在磁盘上的文件，进程除了有文本段，还有进程ID、程序计数器PC、PCB进程控制块、处理器寄存器、堆栈（函数参数、返回地址、局部变量）、数据段（全局变量）、堆。

- 动态性
- 并发性
- 独立性
- 异步性。因此需要同步机制。

## 进程状态图

- 新建
- 终止
- 等待
- 就绪
- 运行

![](./img/jcztt.png)

## 进程间通信

- 共享内存
- 消息传递
- 套接字
- RPC远程过程调用
- 管道（pipe）：生产者从管道一端写，消费者从管道另一端读。

## 线程

线程是轻量级进程，是一个基本的CPU执行单元，是程序执行流的最小单元。

每个线程包括：线程ID、程序计数器PC、处理器寄存器、堆栈。

与同一进程的其它线程共享：代码段、数据段、打开的文件、信号等等。

进程与线程的区别：

- 进程可以视为系统资源分配单元，线程是一个基本的CPU执行单元。
- 进程拥有资源，线程不具有。
- 进程的上下文切换、创建和撤销开销大，线程的调度、创建和撤销开销小。
- 线程提供了更好的并发性。

## 多线程模型

- 多对一：多个用户线程映射到一个内核线程，并发度不高
- 一对一：并发度高，但开销较大
- 多对多：n个用户线程映射到m个内核线程，n>=m，综合上面的优点。

## 三级调度

- 高级调度（作业调度）：主要工作是决定外存的后备队列中哪个进程被调入到内存中，并给这个作业创建进程，给分配它必要的资源。主要在需要从外存调入一个作业到内存中时发生。
- 中级调度（进程对换）：主要工作是在内存紧张时把就绪队列中暂时得不到执行的进程换到外存，也负责在内存较空闲时把换到外存的进程调回内存。主要在内存紧张需要调出一些进程，或者内存空闲需要把先前调出的进程调回内存时发生。
- 低级调度（进程调度）：主要工作是决定把 CPU 分配给就绪队列中的哪个进程。主要在正在执行的进程放弃 CPU 或者被其他优先级高的进程抢占 CPU 时发生。

## 调度算法

一般要求计算：

- 等待时间
- 轮转时间（周转时间）：作业完成时间-作业到来（或者说提交）时间
- 带权轮转时间：$$\frac{轮转时间}{作业实际运行时间}$$

具体算法包括：

- FCFS先到先服务
- SJF最短作业优先
- 抢占SJF或者最短剩余时间优先
- 优先级调度（教材中数字越小优先级越高）
- 高相应比优先调度，相应比$$R_p=\frac{等待时间+要求服务时间}{要求服务时间}$$
- RR轮转调度
- 多级队列调度：将就绪队列分成多个单独队列，每个队列有自己的调度算法，进程被永久地分配到某个队列
- 多级反馈队列调度：允许进程在队列之前迁移

Little公式如下，其中n为平均队列长度，W为平均等待时间，每秒$\lambda$个新进程到达队列：
$$
n=W\times \lambda
$$
## 实时CPU调度

- 单调速率调度：周期越短，优先级越高。调度N个进程的**最坏情况**下CPU利用率为：$$N(2^{\frac{1}{N}}-1)$$，例如，对于两个进程的系统，如果CPU利用率小于83%，那么一定能够保证完成，反正不能保证。
- EDF最早截止期限优先。可抢占。

## 例题

### T1

- 若每个作业只能建立一个进程，为了照顾短作业用户，应采用（短作业优先调度算法 ）
- 为了照顾紧急作业用户，应采用（ 基于优先级的剥夺调度算法）
- 为了实现人机交互，应采用（时间片轮转调度算法）
- 为了使短作业、长作业和交互作业用户都满意，应采用（ 多级反馈队列调度算法）

